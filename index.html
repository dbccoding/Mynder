<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="A secure, encrypted journaling app with task management and calendar features">
    <title> „Å°„Åà chie - let's talk</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <!-- Load modules in order: database, crypto, ui, app -->
    <script src="database.js"></script>
    <script src="crypto.js"></script>
    <script src="ui.js"></script>
    <script src="app.js"></script>
</head>
<body>
    <!-- Password Lock Screen -->
    <div id="lock-screen" class="lock-screen">
        <div class="lock-container">
            <h1>„Å°„Åà chie</h1>
            <p class="lock-subtitle">Secure Personal Journal</p>
            
            <!-- Onboarding Step 1: Welcome -->
            <div id="onboarding-welcome" class="password-form" style="display: none;">
                <h3>Welcome to Chie</h3>
                <p class="info-text">Chie keeps your journal entries, tasks, and events secure. Your data never leaves your device.</p>
                <p class="info-text">Let's set up your secure account in 3 quick steps.</p>
                <button id="start-onboarding-btn" class="btn-primary">Get Started</button>
            </div>

            <!-- Onboarding Step 2: Set Password -->
            <div id="onboarding-password" class="password-form" style="display: none;">
                <div class="onboarding-progress">
                    <span class="progress-step active">1</span>
                    <span class="progress-line"></span>
                    <span class="progress-step">2</span>
                    <span class="progress-line"></span>
                    <span class="progress-step">3</span>
                </div>
                <h3>Create Your Password</h3>
                <p class="info-text">Choose a strong password. You'll use this to access your journal.</p>
                <input type="password" id="new-password" placeholder="Create password (min 6 characters)" />
                <input type="password" id="confirm-password" placeholder="Confirm password" />
                <div class="button-group">
                    <button id="password-next-btn" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Onboarding Step 3: Recovery Key -->
            <div id="onboarding-recovery" class="password-form" style="display: none;">
                <div class="onboarding-progress">
                    <span class="progress-step complete">‚úì</span>
                    <span class="progress-line complete"></span>
                    <span class="progress-step active">2</span>
                    <span class="progress-line"></span>
                    <span class="progress-step">3</span>
                </div>
                <h3>Save Your Recovery Key</h3>
                <p class="info-text"><strong>Important:</strong> If you forget your password, this recovery key is the ONLY way to access your data. Save it somewhere safe.</p>
                <div class="recovery-key-box">
                    <div id="recovery-key-display" class="recovery-key"></div>
                    <div class="recovery-actions">
                        <button id="copy-recovery-btn" class="btn-secondary">Copy to Clipboard</button>
                        <button id="download-recovery-btn" class="btn-secondary">Download as Text</button>
                    </div>
                </div>
                <div class="warning-box">
                    ‚ö†Ô∏è Write this down or save it in a password manager. Do not lose it!
                </div>
                <div class="button-group">
                    <button id="recovery-next-btn" class="btn-primary">I've Saved It</button>
                </div>
            </div>

            <!-- Onboarding Step 4: Confirm Recovery Key -->
            <div id="onboarding-confirm" class="password-form" style="display: none;">
                <div class="onboarding-progress">
                    <span class="progress-step complete">‚úì</span>
                    <span class="progress-line complete"></span>
                    <span class="progress-step complete">‚úì</span>
                    <span class="progress-line complete"></span>
                    <span class="progress-step active">3</span>
                </div>
                <h3>Verify Recovery Key</h3>
                <p class="info-text">To make sure you saved it correctly, please enter your recovery key:</p>
                <textarea id="confirm-recovery-input" placeholder="Paste or type your recovery key here" rows="3"></textarea>
                <div class="button-group">
                    <button id="back-to-recovery-btn" class="btn-secondary">Back</button>
                    <button id="confirm-recovery-btn" class="btn-primary">Confirm & Finish</button>
                </div>
            </div>

            <!-- Unlock with Password -->
            <div id="unlock-password" class="password-form" style="display: none;">
                <h3>Welcome Back</h3>

                <input type="password" id="unlock-password-input" placeholder="Enter password to unlock" />
                <button id="unlock-btn" class="btn-primary">Unlock</button>
                <button id="show-recovery-option-btn" class="btn-text">Forgot password? Use recovery key</button>
                <div id="unlock-error" class="error-message"></div>
            </div>

            <!-- Unlock with Recovery Key -->
            <div id="unlock-recovery" class="password-form" style="display: none;">
                <h3>Recover Access</h3>
                <p class="info-text">Enter your recovery key to regain access to your journal</p>
                <textarea id="recovery-key-input" placeholder="Enter your recovery key" rows="3"></textarea>
                <button id="unlock-recovery-btn" class="btn-primary">Unlock with Recovery Key</button>
                <button id="back-to-password-btn" class="btn-text">Back to password</button>
                <div id="recovery-unlock-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <div class="container" style="display: none;">
        <header>
            <div class="header-content">
                <div>
                    <h1>Chie</h1>
                    <p class="subtitle">Your Personal Journal & Task Manager</p>
                </div>
                <div class="header-actions">
                    <label class="mood-ring-toggle" title="Toggle mood-based background colors">
                        <input type="checkbox" id="mood-ring-toggle" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Mood Ring</span>
                    </label>
                    <button id="install-app-btn" class="install-btn" style="display: none;" title="Install App">Install</button>
                    <button id="lock-app-btn" class="lock-btn" title="Lock App">üîí</button>
                </div>
            </div>
        </header>

        <!-- Mini Calendar Widget -->
        <div class="mini-calendar">
            <div class="calendar-header">
                <button class="calendar-nav" id="prev-month">‚Äπ</button>
                <div class="calendar-month-year" id="current-month-year"></div>
                <button class="calendar-nav" id="next-month">‚Ä∫</button>
                <button class="calendar-toggle" id="calendar-toggle" title="Collapse/Expand Calendar">‚ñº</button>
            </div>
            <div class="calendar-weekdays">
                <div class="weekday">Sun</div>
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar days will be generated here -->
            </div>
        </div>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="journal">Journal</button>
            <button class="tab-btn" data-tab="tasks">Tasks</button>
            <button class="tab-btn" data-tab="calendar">Calendar</button>
        </nav>

        <!-- Journal Tab -->
        <div id="journal" class="tab-content active">
            <div class="journal-section">
                <h2>Today's Journal</h2>
                <div class="journal-form">
                    <input type="text" id="journal-title" placeholder="Entry title (optional)" />
                    <textarea id="journal-entry" placeholder="Write your thoughts here..." rows="6"></textarea>
                    <button id="add-journal-btn" class="btn-primary">Add Entry</button>
                </div>
                <div id="journal-entries" class="entries-list">
                    <!-- Journal entries will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="tasks-section">
                <h2>Tasks & To-Do Lists</h2>
                <div class="task-form">
                    <input type="text" id="task-input" placeholder="Add a new task..." />
                    <button id="add-task-btn" class="btn-primary">Add Task</button>
                </div>
                <div id="task-list" class="task-list">
                    <!-- Tasks will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="calendar-section">
                <h2>Events Calendar</h2>
                <div class="event-form">
                    <input type="text" id="event-title" placeholder="Event title" />
                    <input type="datetime-local" id="event-date" />
                    <textarea id="event-description" placeholder="Event description (optional)" rows="2"></textarea>
                    <button id="add-event-btn" class="btn-primary">Add Event</button>
                </div>
                <div id="events-list" class="events-list">
                    <!-- Events will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Register Service Worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Handle PWA install prompt
        let deferredPrompt;
        const installBtn = document.getElementById('install-app-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show the install button
            if (installBtn) {
                installBtn.style.display = 'block';
            }
        });

        // Handle install button click
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    return;
                }

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        // Track if app was installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        });
    </script>
</body>
</html>
